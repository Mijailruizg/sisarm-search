{% extends "partidas/base.html" %}

{% load static %}
{% block extra_styles %}
<style>
    body.detalle-bg {
        background-image: url('{% static "img/fondo.jpg.png" %}');
        background-size: cover;
        background-repeat: no-repeat;
        background-attachment: fixed;
        background-position: center;
    }
    .main-menu-container { max-width: 980px; margin: 3.5rem auto; padding: 2.2rem; text-align: center; background-color: rgba(255,255,255,0.95); border-radius: 14px; box-shadow: 0 8px 34px rgba(0,0,0,0.14); z-index: 2; position: relative; }
    .main-menu-container h2 { font-size: 2.05rem; margin-bottom: 1.2rem; color: #003366; letter-spacing: 0.3px; }
    /* Grilla fija en escritorio para control del orden y responsive para móvil */
    .button-grid { display: grid; grid-template-columns: repeat(3, minmax(220px, 1fr)); gap: 1rem; align-items: stretch; }
    /* Asegurar botones de altura consistente */
    .button-grid a { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 64px; padding: 0.9rem 1rem; text-decoration: none; background-color: #cce5ff; color: #003366; font-weight: 700; border: 0; border-radius: 10px; transition: background-color 0.18s ease, transform 0.08s ease, box-shadow 0.12s ease; box-shadow: 0 2px 6px rgba(0,0,0,0.06); }
    .button-grid a:hover { background-color: #b3d7ff; transform: translateY(-3px); box-shadow: 0 6px 18px rgba(0,0,0,0.12); }
    .button-grid a:focus { outline: 3px solid rgba(0,51,102,0.12); outline-offset: 2px; }
    .button-grid a.small { min-height: 52px; font-weight: 700; }
    /* Mantener clases para accesibilidad si se necesitan */
    .button-grid a.secondary, .button-grid a.important { background-color: #cce5ff; color: #003366; }
    /* Texto de licencia/herramienta */
    .texto-licencia { margin: 1rem auto 0; max-width: 980px; text-align: center; color: #003366; font-weight: 600; background: transparent; padding: 0.45rem 0.8rem; border-radius: 8px; box-shadow: none; }
    .marca-agua { position: fixed; bottom: 16px; right: 20px; opacity: 0.4; font-size: 0.85rem; color: #ffffff; pointer-events: none; z-index: 1000; }

    /* Responsive: en pantallas pequeñas, 1 o 2 columnas */
    @media (max-width: 820px) {
        .button-grid { grid-template-columns: repeat(2, minmax(180px, 1fr)); }
    }
    @media (max-width: 520px) {
        .main-menu-container { margin: 1.2rem; padding: 1rem; }
        .button-grid { grid-template-columns: 1fr; gap: 0.8rem; }
        .main-menu-container h2 { font-size: 1.45rem; }
    }
    /* Botón fijo de chat (centrado abajo) */
    .chat-fixed {
        position: fixed;
        left: 50%;
        transform: translateX(-50%);
        bottom: 22px;
        background-color: #cce5ff;
        color: #003366;
        padding: 0.7rem 1.1rem;
        border-radius: 999px;
        box-shadow: 0 8px 20px rgba(0,0,0,0.16);
        font-weight: 800;
        text-decoration: none;
        z-index: 1500;
        display: inline-flex;
        align-items: center;
        gap: 0.6rem;
    }
    .chat-fixed:hover { background-color: #b3d7ff; transform: translateX(-50%) translateY(-3px); }
    .chat-fixed:focus { outline: 3px solid rgba(0,51,102,0.14); outline-offset: 4px; }
    @media (max-width: 420px) {
        .chat-fixed { bottom: 14px; padding: 0.6rem 0.9rem; font-weight: 700; }
    }
</style>
{% endblock %}

{% block body_class %}detalle-bg{% endblock %}

{% block content %}

<div class="main-menu-container">
    <h2>Bienvenido a SISARM Search</h2>

    <div class="button-grid" role="navigation" aria-label="Menú principal">
        <!-- Orden fijo visual: Buscar | Ver todos | Estadísticas
             Historial | Importar (staff) / Manuales | Manuales / Chat  -->
        <a href="{% url 'buscar_partidas' %}">Buscar Partidas</a>
        <a href="{% url 'lista_aranceles' %}">Visualizar capítulos y partidas</a>
        <a href="{% url 'estadisticas_aranceles' %}">Estadísticas de Aranceles</a>

        <a href="{% url 'historial_buscador' %}">Historial</a>
        {% if request.user.is_staff %}
            <a href="{% url 'importar_excel' %}">Importar Excel</a>
            <a href="{% url 'manuales' %}">Manuales</a>
        {% else %}
            <!-- Cuando no es staff, mostramos Manuales aquí (sin importar) -->
            <a href="{% url 'manuales' %}">Manuales</a>
        {% endif %}
        <!-- También mostrar Chat como botón dentro de la grilla de inicio -->
        <a href="{% url 'chat_asistente' %}">Chat de Ayuda</a>
    </div>
</div>


{% if dias_licencia is not None %}
<div class="texto-licencia" aria-live="polite">
    Licencia expira en ...
</div>
{% endif %}
<script>
    (function(){
        // fechaFin llega desde el servidor como ISO (YYYY-MM-DD or YYYY-MM-DDTHH:MM:SS)
        // Calculamos días de forma neutral a zona horaria y en modo "inclusivo"
        const fechaFin = '{{ fecha_fin_iso|default:"" }}';
        if(!fechaFin) return;
        const licenciaDiv = document.querySelector('.texto-licencia');
        const MS_PER_DAY = 1000 * 60 * 60 * 24;
        function actualizar(){
            const ahora = new Date();
            const fin = new Date(fechaFin);
            // Normalizar ambos a la medianoche local para evitar desfases por zona horaria
            ahora.setHours(0,0,0,0);
            fin.setHours(0,0,0,0);
            const diff = fin - ahora;
            if(diff < 0){
                licenciaDiv.textContent = 'Licencia expirada';
                return;
            }
            // raw_days equivalente a (fecha_fin - hoy).days en servidor
            const raw_days = Math.floor(diff / MS_PER_DAY);
            // en el backend mostramos raw_days + 1 (conteo inclusivo)
            const dias_inclusivos = raw_days + 1;
            if(dias_inclusivos > 0){
                licenciaDiv.textContent = `Licencia expira en ${dias_inclusivos}d`;
            } else {
                licenciaDiv.textContent = 'Licencia expira hoy';
            }
        }
        actualizar();
        // actualizar cada minuto es suficiente
        setInterval(actualizar, 60000);
    })();
</script>
<div class="marca-agua">
    ©2025 SIS Code Creator – Para SISARM Bolivia
</div>
{% endblock %}
