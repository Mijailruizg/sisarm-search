{% extends "partidas/base.html" %}
{% load static %}

{% block extra_styles %}
<style>
    body.detalle-bg {
        background-image: url('{% static "img/fondo.jpg.png" %}');
        background-size: cover;
        background-repeat: no-repeat;
        background-attachment: fixed;
        background-position: center;
    }

    .chat-container {
        max-width: 800px;
        margin: 4rem auto;
        background: rgba(255,255,255,0.97);
        border-radius: 20px;
        box-shadow: 0 0 30px rgba(0,0,0,0.27);
        padding: 2.5rem;
        animation: fadeInUp 0.4s ease;
    }

    .chat-title {
        font-size: 2.3rem;
        text-align: center;
        margin-bottom: 2rem;
        font-weight: bold;
        color: #1f1f1f;
    }

    .chat-wrapper {
        display: flex;
        flex-direction: column;
        max-height: 480px;
        overflow-y: auto;
        scroll-behavior: smooth;
        padding-right: 1rem;
    }

    .chat-bubble {
        padding: 1rem 1.5rem;
        margin-bottom: 1rem;
        border-radius: 20px;
        max-width: 90%;
        animation: fadeInUp 0.3s ease-in-out;
        word-break: break-word;
        white-space: pre-wrap;
        line-height: 1.4;
    }

    .chat-user {
        background-color: #cfe4ff;
        align-self: flex-end;
    }

    .chat-bot {
        background-color: #e3fbea;
        align-self: flex-start;
    }

    .input-group input, .input-group .btn {
        border-radius: 12px;
        font-size: 1rem;
    }

    .suggestions {
        margin-top: 1rem;
        display: flex;
        flex-wrap: wrap;
        gap: 0.4rem;
    }

    .badge {
        background-color: #333;
        color: white;
        padding: 0.4rem 0.9rem;
        border-radius: 12px;
        cursor: pointer;
        transition: 0.2s;
    }

    .badge:hover {
        background-color: black;
    }

    @keyframes fadeInUp {
        from {opacity:0; transform: translateY(20px);}
        to {opacity:1; transform:translateY(0);}
    }

    .typing-loader {
        display: flex;
        gap: 6px;
        animation: fadeInUp .2s ease-in-out;
    }

    .typing-loader span {
        width: 8px; height: 8px;
        background-color: #888;
        border-radius: 50%;
        animation: bounce 0.6s infinite alternate;
    }

    .typing-loader span:nth-child(2) {animation-delay: 0.2s;}
    .typing-loader span:nth-child(3) {animation-delay: 0.4s;}

    @keyframes bounce {
        to {transform: translateY(-6px);}
    }
</style>
{% endblock %}

{% block body_class %}detalle-bg{% endblock %}

{% block content %}
<div class="chat-container">
    <h2 class="chat-title">Asistente Virtual</h2>

    <div class="chat-wrapper" id="chatWrapper">
        
        {% if mensaje %}
        <div class="chat-bubble chat-user"><strong>T√∫:</strong> {{ mensaje }}</div>
        {% endif %}

        {% if respuesta %}
        <div class="chat-bubble chat-bot" id="respuestaBot" style="display:none;">
            <strong>Asistente</strong><br><br>
            <div class="respuesta-contenido">{{ respuesta|safe }}</div>

            {% if sugerencias %}
            <div class="suggestions">
                {% for sugerencia in sugerencias %}
                    <span class="badge" data-text="{{ sugerencia|escapejs }}">{{ sugerencia }}</span>
                {% endfor %}
            </div>
            {% endif %}
        </div>

        <div id="typingIndicator" class="chat-bubble chat-bot">
            <div class="typing-loader"><span></span><span></span><span></span></div>
        </div>
        {% endif %}
    </div>
        <!-- Modal Bootstrap: acci√≥n sugerida por el servidor -->
        <div class="modal fade" id="actionModal" tabindex="-1" aria-labelledby="actionModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="actionModalLabel">Acci√≥n sugerida</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                    </div>
                    <div class="modal-body">
                        <div id="actionTextModal" style="font-weight:600; color:#333;"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" id="actionModalOpenBtn" class="btn btn-primary">Abrir</button>
                        <button type="button" id="actionModalIgnoreBtn" class="btn btn-secondary" data-bs-dismiss="modal">Ignorar</button>
                    </div>
                </div>
            </div>
        </div>

    <form id="chatForm" method="post" class="mt-4" onsubmit="return false;">
        {% csrf_token %}
        <div class="input-group">
            <input id="campoMensaje" type="text" name="mensaje"
                class="form-control"
                placeholder="Escribe algo, por ejemplo: ‚Äòhola‚Äô üòÑ" autofocus>
            <button id="btnEnviar" class="btn btn-primary">Enviar</button>
        </div>
    </form>
</div>

<div id="serverActionData" data-action='{{ action_json|escapejs }}' style="display:none;"></div>
<script>
/* acci√≥n enviada desde el servidor cuando la p√°gina se renderiza (ej. abrir soporte) */
var serverAction = null;

function handleAction(action){
    if(!action) return;
    try{
        if(action.open_support){ window.location.href = action.open_support; return; }
        if(action.open_whatsapp){ window.open(action.open_whatsapp, '_blank'); return; }
    }catch(e){ console.error('Error ejecutando action:', e); }
}

function showActionPanel(action){
    if(!action) return;
    const textDiv = document.getElementById('actionTextModal');
    let text = 'Acci√≥n sugerida';
    try{
        if(action.action_text) text = action.action_text;
        else if(action.open_support) text = 'El asistente sugiere abrir la p√°gina de Soporte.';
        else if(action.open_whatsapp) text = 'El asistente sugiere abrir WhatsApp para chatear con soporte.';
    }catch(e){ console.error(e); }
    textDiv.textContent = text;
    const modalEl = document.getElementById('actionModal');
    modalEl.dataset.action = JSON.stringify(action);
    try{
        if(window.bootstrap && typeof window.bootstrap.Modal === 'function'){
            const m = new bootstrap.Modal(modalEl);
            m.show(); modalEl._bs_instance = m; return;
        }
    }catch(e){ console.warn('Bootstrap modal API no disponible, fallback a mostrar elemento'); }
    modalEl.style.display = 'block';
}

function hideActionPanel(){
    const modalEl = document.getElementById('actionModal'); if(!modalEl) return;
    try{ if(modalEl._bs_instance){ modalEl._bs_instance.hide(); delete modalEl._bs_instance; return; } }catch(e){}
    modalEl.style.display = 'none';
}

// Helper CSRF (leer cookie)
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function escapeHTML(s){
    return String(s).replace(/[&<>\"']/g, function(m){ return {'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;',"'":"&#39;"}[m]; });
}

// A√±adir burbujas al chat. si html=true se usa innerHTML (backend controla seguridad); por defecto escapa
function appendBubble(text, who='bot', html=false){
    const chat = document.getElementById('chatWrapper');
    const div = document.createElement('div');
    div.className = 'chat-bubble ' + (who === 'user' ? 'chat-user' : 'chat-bot');
    if(who === 'user'){
        div.innerHTML = `<strong>T√∫:</strong> ${escapeHTML(text)}`;
    }else{
        if(html) div.innerHTML = `<strong>Asistente</strong><br><br><div class="respuesta-contenido">${text}</div>`;
        else div.innerHTML = `<strong>Asistente</strong><br><br><div class="respuesta-contenido">${escapeHTML(text)}</div>`;
    }
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
    return div;
}

function showErrorBubble(text){
    const bubble = appendBubble(text, 'bot', false);
    bubble.style.backgroundColor = '#ffd6d6';
    bubble.style.border = '1px solid #ff9b9b';
}

async function sendMessageToApi(message, {stream=false, publico=false, timeout=30000} = {}){
    const url = '{% url "api_chat_help" %}';
    const csrftoken = getCookie('csrftoken');
    const body = new URLSearchParams();
    body.append('message', message);
    // adjuntar session_id (contexto por usuario) si existe o generarlo
    try{
        let sessionId = localStorage.getItem('df_session_id');
        if(!sessionId){
            if(window.crypto && crypto.randomUUID){ sessionId = crypto.randomUUID(); }
            else sessionId = 'anon-' + Math.random().toString(36).slice(2,10);
            localStorage.setItem('df_session_id', sessionId);
        }
        body.append('session_id', sessionId);
    }catch(e){ /* no cr√≠tico */ }
    if(stream) body.append('stream', '1');
    if(publico) body.append('public', '1');

    const controller = new AbortController();
    const id = setTimeout(()=> controller.abort(), timeout);

    try{
        const resp = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded', 'X-CSRFToken': csrftoken },
            body: body.toString(),
            credentials: 'same-origin',
            signal: controller.signal
        });
        clearTimeout(id);
        if(!resp.ok){
            throw new Error(`HTTP ${resp.status}: ${resp.statusText}`);
        }
        return await resp.json();
    }catch(e){
        clearTimeout(id);
        throw e;
    }
}

document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('chatForm');
    const campo = document.getElementById('campoMensaje');
    const btn = document.getElementById('btnEnviar');

    async function doSend(){
        const text = campo.value.trim();
        if(!text) return;
        // mostrar mensaje del usuario
        appendBubble(text, 'user');
        campo.value = '';
        btn.disabled = true; campo.disabled = true;
        const typing = appendBubble('<div class="typing-loader"><span></span><span></span><span></span></div>', 'bot', true);

        try{
            const resp = await sendMessageToApi(text, {stream: false});
            typing.remove();
            if(resp.ok){
                appendBubble(resp.reply, 'bot', true);
                if(resp.action){
                    try{
                        if(resp.action.auto_open){ handleAction(resp.action); }
                        else showActionPanel(resp.action);
                    }catch(e){ console.error('action handling error', e); showActionPanel(resp.action); }
                }
            }else showErrorBubble('Error: ' + (resp.error || 'respuesta inv√°lida'));
        }catch(e){
            typing.remove();
            console.error(e);
            if(e.name === 'AbortError') showErrorBubble('Tiempo de espera agotado. Intenta nuevamente.');
            else showErrorBubble('Error de conexi√≥n con la API del asistente.');
        }finally{
            btn.disabled = false; campo.disabled = false; campo.focus();
        }
    }

    btn.addEventListener('click', async (ev) => { ev.preventDefault(); await doSend(); });
    campo.addEventListener('keydown', async (ev) => { if(ev.key === 'Enter' && !ev.shiftKey){ ev.preventDefault(); await doSend(); } });

    // scroll inicial y mostrar respuesta renderizada si existe
    const chat = document.getElementById('chatWrapper'); chat.scrollTop = chat.scrollHeight;
    const respuestaBot = document.getElementById('respuestaBot');
    const typingIndicator = document.getElementById('typingIndicator');
    if (respuestaBot && typingIndicator) {
        setTimeout(() => { typingIndicator.style.display = 'none'; respuestaBot.style.display = 'block'; chat.scrollTop = chat.scrollHeight; }, 900);
    }

    document.querySelectorAll('.badge').forEach(b => { b.addEventListener('click', async () => { document.getElementById('campoMensaje').value = b.dataset.text; try{ await doSend(); }catch(e){ console.error('Error auto-enviando sugerencia', e); } }); });

    // Mostrar modal si el servidor envi√≥ una acci√≥n al renderizar
    try{ const serverActionEl = document.getElementById('serverActionData'); if(serverActionEl && serverActionEl.dataset && serverActionEl.dataset.action){ const raw = serverActionEl.dataset.action; if(raw && raw !== 'null'){ try{ serverAction = JSON.parse(raw); }catch(e){ console.warn('No se pudo parsear serverAction', e); } } } }catch(e){}

    if(typeof serverAction !== 'undefined' && serverAction){
        try{ if(serverAction.auto_open) handleAction(serverAction); else showActionPanel(serverAction); }catch(e){ showActionPanel(serverAction); }
    }

    // Wiring botones del modal de acci√≥n
    const openBtn = document.getElementById('actionModalOpenBtn');
    const ignoreBtn = document.getElementById('actionModalIgnoreBtn');
    const modalEl = document.getElementById('actionModal');
    if(openBtn){ openBtn.addEventListener('click', () => { try{ const action = JSON.parse(modalEl.dataset.action || '{}'); handleAction(action); }catch(e){ console.error('action parse error', e) } hideActionPanel(); }); }
    if(ignoreBtn){ ignoreBtn.addEventListener('click', () => { hideActionPanel(); }); }
});
</script>
{% endblock %}
