{% extends "partidas/base.html" %}
{% load static %}

{% block content %}
<div class="container mt-4">
  <h2>Historial de Búsquedas (Admin)</h2>
  <form class="row g-2 my-3" method="get">
    <div class="col-md-3">
      <input type="text" name="usuario" class="form-control" placeholder="Usuario" value="{{ filtros.usuario }}">
    </div>
    <div class="col-md-3">
      <input type="text" name="termino" class="form-control" placeholder="Término" value="{{ filtros.termino }}">
    </div>
    <div class="col-md-2">
      <input type="date" name="desde" class="form-control" value="{{ filtros.desde }}">
    </div>
    <div class="col-md-2">
      <input type="date" name="hasta" class="form-control" value="{{ filtros.hasta }}">
    </div>
    <div class="col-md-2">
      <button class="btn btn-primary" type="submit">Filtrar</button>
      <a class="btn btn-outline-secondary" href="?export=csv{% if filtros.usuario %}&usuario={{ filtros.usuario }}{% endif %}{% if filtros.termino %}&termino={{ filtros.termino }}{% endif %}{% if filtros.desde %}&desde={{ filtros.desde }}{% endif %}{% if filtros.hasta %}&hasta={{ filtros.hasta }}{% endif %}">Exportar CSV</a>
    </div>
  </form>

  <div class="table-responsive">
    <table class="table table-striped">
      <thead>
        <tr>
          <th>Usuario</th>
          <th>Término</th>
          <th>Resumen resultados</th>
          <th>Fecha / Hora</th>
        </tr>
      </thead>
      <tbody>
        {% for b in busquedas %}
        <tr>
          <td>{{ b.usuario.username }}</td>
          <td>{{ b.termino_buscado }}</td>
          <td style="max-width:400px;">
            <span title="{{ b.resultados|escape }}" style="display:inline-block; max-width:380px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; vertical-align:middle;">{{ b.resultados }}</span>
          </td>
          <td>{{ b.fecha }}</td>
        </tr>
        {% empty %}
        <tr><td colspan="3">No se encontraron registros.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  <p class="text-muted">Mostrando hasta 500 registros. Use filtros para reducir el conjunto y exportar.</p>
</div>
{% endblock %}